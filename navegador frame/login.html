<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="css/login.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div class="header-navigation">
        <div class="header-navigation-logo"><img src="images/phddobrasil.png" alt=""></div>
        <div class="header-navigation-btns">
            <button class="navigationBtn minimizeBtn" title="Minimize"></button>
            <button class="navigationBtn maximizeBtn" title="Maximize"></button>
            <button class="navigationBtn closeBtn" title="Close"></button>
        </div>
    </div>
    <div class="contentArea">
        <div class="login">
            <div class="login-text">

                <span>Seja Bem vindo</span>
                <span>a Phd do Brasil!</span>
                <div id="response"></div>
            </div>
            <div class="login-area">
                <form id="form">
                    <label for="email">Email</label><br>
                    <input type="text" class="login-input" id="email" placeholder="Email" name="email"><br>
                    <label for="senha">Senha</label><br>
                    <input type="password" class="login-input" id="password" placeholder="Senha" name="password">
                    <br>
                    <input type="checkbox" name="check">
                    <label for="check" class="label-check">Lembre-se de mim</label>
                    <br>
                    <div class="button-form">
                        <button class="loginBtn" id="loginBtn">Login</button>
                    </div>
                </form>


            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const $ = require('jquery');
        const { remote } = require('electron');
        const path = require('path');
        const { ipcRenderer } = require('electron')
        const ipc = ipcRenderer
        const maxResBtn = document.querySelector('maximizeBtn')
        const login = document.querySelector('.login')
        var isLeftMenuActive = true

        document.querySelector('.closeBtn').addEventListener('click', () => {
            ipc.send('closeApp')
        })
        document.querySelector('.minimizeBtn').addEventListener('click', () => {
            ipc.send('minimizeApp')
        })
        function changeMaxResBtn(isMaximizedApp) {
            if (isMaximizedApp) {
                maxResBtn.title = 'Restore'
                maxResBtn.classList.remove('maximizeBtn')
                maxResBtn.classList.add('restoreBtn')
            } else {
                maxResBtn.title = 'Maximize'
                maxResBtn.classList.remove('restoreBtn')
                maxResBtn.classList.add('maximizeBtn')
            }
        }
        document.querySelector('.maximizeBtn').addEventListener('click', () => {
            ipc.send('maximizeRestoreApp')
        })
        ipc.on('isMaximized', () => { changeMaxResBtn(true) })
        ipc.on('isRestored', () => { changeMaxResBtn(false) })

        $(document).ready(function () {
                const token = localStorage.getItem('sessionToken');

                if (!token) {
                    console.log('ola')
                } else {
                    $.ajax({
                        type: 'GET',
                        url: 'http://192.168.10.80/api/user',
                        headers: { 'Authorization': 'Bearer ' + token },
                        success: function (response) {
                            window.location.href = 'index.html'
                        },
                        error: function () {
                            // window.location.href = 'login.html';
                        }
                    });
                }
            }
        );

        $("#form").on('submit', function (e) {

            // nao submeter o form pelo php
            e.preventDefault();
            const email = $('#email').val();
            const password = $('#password').val();

            // ajax
            $.ajax({
                type: 'POST',
                url: 'http://192.168.10.80/api/auth',
                data: new FormData(this),
                dataType: 'json',
                contentType: false,
                cache: false,
                processData: false,
                beforeSend: function () {
                    $("#response").html('');
                    $("#loginBtn").val('validando...');
                },
                success: function (response) {

                    $("#loginBtn").val('entrar');
                    $("#loginBtn").removeAttr("disabled");

                    if (!response.errors && !response.message) {
                        localStorage.setItem('sessionToken', response.token);
                        window.location.replace('index.html');
                    } else {
                        if (typeof response.message === 'string') {
                            console.log(response.message);
                            $("#response").append('<p class="text-danger">' + response.message + '</p>');
                        } else if (Array.isArray(response.message)) {
                            $.each(response.message, function (i, val) {
                                $("#response").append('<ul class="list-unstyled"> <li class="text-danger">' + val + '</li> </ul>');
                            });
                        }
                        if (response.errors) {
                            $.each(response.errors, function (key, value) {

                                $("#response").append('<ul class="list-unstyled"> <li class="text-danger">' + value + '</li> </ul>');

                            });
                        }

                        setTimeout(function () {
                            $("#response").html('');
                            $("#response").removeClass('alert alert-danger');
                        }, 3000);
                    }
                },
                errors: function () {
                    alert('Erro ao enviar formulÃ¡rio, por favor contate nosso suporte:(11)94952-2579 E-mail: console.tech@outlook.com');
                    $("#loginBtn").val('entrar');
                    $("#loginBtn").removeAttr("disabled");
                },

            });

        });
        $("form").submit(function () {
            $(this).find(":submit").attr('disabled', 'disabled');
        });
        if (window.location.pathname.endsWith('index.html')) {
            const token = localStorage.getItem('sessionToken');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        const logoutButton = document.getElementById('logout');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('sessionToken');
                window.location.href = 'login.html';
            });
        }
    </script>
</body>

</html>